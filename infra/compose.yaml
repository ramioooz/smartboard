##############################################################################
# Smartboard — Docker Compose (Local Dev)
# Run: docker compose -f infra/compose.yaml up
# Project name "smartboard" is the only prefix; service names are plain.
# Build context for all app services is the monorepo root (../),
# so Dockerfiles can access the full workspace during multi-stage builds.
##############################################################################

name: smartboard

services:
  # ── Infrastructure ───────────────────────────────────────────────────────────

  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-smartboard}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-smartboard}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - smartboard-pgdata:/var/lib/postgresql/data
      - ./scripts/init-schemas.sql:/docker-entrypoint-initdb.d/init-schemas.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-smartboard} -d ${POSTGRES_DB:-smartboard}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - smartboard-net

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - smartboard-redisdata:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - smartboard-net

  minio:
    image: minio/minio:latest
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - smartboard-miniodata:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:9000/minio/health/live"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - smartboard-net

  # MinIO bucket initialiser — runs once to create the datasets bucket
  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
        mc alias set local http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD};
        mc mb --ignore-existing local/${MINIO_BUCKET_DATASETS:-smartboard-datasets};
        mc anonymous set none local/${MINIO_BUCKET_DATASETS:-smartboard-datasets};
        echo 'MinIO bucket initialised.';
      "
    networks:
      - smartboard-net
    restart: "no"

  # ── Backend Services ─────────────────────────────────────────────────────────

  svc-auth:
    build:
      context: ../
      dockerfile: apps/svc-auth/Dockerfile
    image: smartboard-svc-auth:local
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 4010
      LOG_LEVEL: ${LOG_LEVEL}
      DATABASE_URL: postgresql://${POSTGRES_USER:-smartboard}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-smartboard}?schema=auth
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-15m}
      REFRESH_TOKEN_EXPIRES_IN: ${REFRESH_TOKEN_EXPIRES_IN:-7d}
      SESSION_SECRET: ${SESSION_SECRET}
      MICROSOFT_CLIENT_ID: ${MICROSOFT_CLIENT_ID:-}
      MICROSOFT_CLIENT_SECRET: ${MICROSOFT_CLIENT_SECRET:-}
      MICROSOFT_TENANT_ID: ${MICROSOFT_TENANT_ID:-}
      MICROSOFT_REDIRECT_URI: ${MICROSOFT_REDIRECT_URI:-http://localhost:4000/auth/microsoft/callback}
      DEV_BYPASS_AUTH: ${DEV_BYPASS_AUTH:-false}
      DEV_DEFAULT_EMAIL: ${DEV_DEFAULT_EMAIL:-dev@local}
    expose:
      - "4010"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:4010/health/ready"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - smartboard-net

  svc-tenants:
    build:
      context: ../
      dockerfile: apps/svc-tenants/Dockerfile
    image: smartboard-svc-tenants:local
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 4020
      LOG_LEVEL: ${LOG_LEVEL}
      DATABASE_URL: postgresql://${POSTGRES_USER:-smartboard}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-smartboard}?schema=tenants
    expose:
      - "4020"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:4020/health/ready"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - smartboard-net

  svc-datasets:
    build:
      context: ../
      dockerfile: apps/svc-datasets/Dockerfile
    image: smartboard-svc-datasets:local
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 4030
      LOG_LEVEL: ${LOG_LEVEL}
      DATABASE_URL: postgresql://${POSTGRES_USER:-smartboard}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-smartboard}?schema=datasets
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      MINIO_ENDPOINT: minio
      MINIO_PORT: 9000
      MINIO_USE_SSL: "false"
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_BUCKET_DATASETS: ${MINIO_BUCKET_DATASETS:-smartboard-datasets}
    expose:
      - "4030"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:4030/health/ready"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - smartboard-net

  svc-analytics:
    build:
      context: ../
      dockerfile: apps/svc-analytics/Dockerfile
    image: smartboard-svc-analytics:local
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 4040
      LOG_LEVEL: ${LOG_LEVEL}
      DATABASE_URL: postgresql://${POSTGRES_USER:-smartboard}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-smartboard}?schema=analytics
    expose:
      - "4040"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:4040/health/ready"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - smartboard-net

  svc-dashboards:
    build:
      context: ../
      dockerfile: apps/svc-dashboards/Dockerfile
    image: smartboard-svc-dashboards:local
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 4050
      LOG_LEVEL: ${LOG_LEVEL}
      DATABASE_URL: postgresql://${POSTGRES_USER:-smartboard}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-smartboard}?schema=dashboards
    expose:
      - "4050"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:4050/health/ready"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - smartboard-net

  svc-realtime:
    build:
      context: ../
      dockerfile: apps/svc-realtime/Dockerfile
    image: smartboard-svc-realtime:local
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 4060
      LOG_LEVEL: ${LOG_LEVEL}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      SESSION_SECRET: ${SESSION_SECRET}
    expose:
      - "4060"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:4060/health/ready"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - smartboard-net

  worker:
    build:
      context: ../
      dockerfile: apps/worker/Dockerfile
    image: smartboard-worker:local
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 4070
      LOG_LEVEL: ${LOG_LEVEL}
      DATABASE_URL: postgresql://${POSTGRES_USER:-smartboard}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-smartboard}?schema=analytics
      DATABASE_URL_DATASETS: postgresql://${POSTGRES_USER:-smartboard}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-smartboard}?schema=datasets
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      MINIO_ENDPOINT: minio
      MINIO_PORT: 9000
      MINIO_USE_SSL: "false"
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_BUCKET_DATASETS: ${MINIO_BUCKET_DATASETS:-smartboard-datasets}
    expose:
      - "4070"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:4070/health/ready"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - smartboard-net

  gateway:
    build:
      context: ../
      dockerfile: apps/gateway/Dockerfile
    image: smartboard-gateway:local
    restart: unless-stopped
    depends_on:
      svc-auth:
        condition: service_healthy
      svc-tenants:
        condition: service_healthy
      svc-datasets:
        condition: service_healthy
      svc-analytics:
        condition: service_healthy
      svc-dashboards:
        condition: service_healthy
      svc-realtime:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 4000
      LOG_LEVEL: ${LOG_LEVEL}
      SESSION_SECRET: ${SESSION_SECRET}
      JWT_SECRET: ${JWT_SECRET}
      DEV_BYPASS_AUTH: ${DEV_BYPASS_AUTH:-false}
      # Service discovery — docker compose DNS
      AUTH_SERVICE_URL: http://svc-auth:4010
      TENANTS_SERVICE_URL: http://svc-tenants:4020
      DATASETS_SERVICE_URL: http://svc-datasets:4030
      ANALYTICS_SERVICE_URL: http://svc-analytics:4040
      DASHBOARDS_SERVICE_URL: http://svc-dashboards:4050
      REALTIME_SERVICE_URL: http://svc-realtime:4060
    # No host port mapping — nginx handles all inbound traffic.
    # To scale: docker compose -f infra/compose.yaml up -d --scale gateway=3
    expose:
      - "4000"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:4000/health/ready"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - smartboard-net

  nginx:
    image: nginx:1.27-alpine
    restart: unless-stopped
    depends_on:
      gateway:
        condition: service_healthy
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "${NGINX_PORT:-80}:80"
    networks:
      - smartboard-net

  web:
    build:
      context: ../
      dockerfile: apps/web/Dockerfile
    image: smartboard-web:local
    restart: unless-stopped
    depends_on:
      nginx:
        condition: service_started
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3000
      HOSTNAME: "0.0.0.0"
      # All API traffic goes through nginx → gateway (load-balanced)
      NEXT_PUBLIC_GATEWAY_URL: ${NEXT_PUBLIC_GATEWAY_URL:-http://127.0.0.1}
      NEXT_PUBLIC_DEV_BYPASS_AUTH: ${DEV_BYPASS_AUTH:-false}
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:3000/"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - smartboard-net

# ── Volumes ───────────────────────────────────────────────────────────────────
volumes:
  smartboard-pgdata:
    name: smartboard-pgdata
  smartboard-redisdata:
    name: smartboard-redisdata
  smartboard-miniodata:
    name: smartboard-miniodata

# ── Networks ──────────────────────────────────────────────────────────────────
networks:
  smartboard-net:
    name: smartboard-net
    driver: bridge
